# AWS Setup
This document exists to show what I have done to set up the AWS environment for performance benchmarking. It was written by Vicram Rajagopalan.
## VPC
I set up a VPC using the steps [here](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html#create-a-vpc). I first tried creating it in the N. Virginia region, but I got an error message saying "you've reached your limit of VPCs" or something like that, so I tried again with Ohio and it worked. **This means that you need to set your region to Ohio in order to use the VPC.**
* I named the VPC "benchmarking".
* The VPC ID is "vpc-0021b44045f7ffd68".
* The IPv4 CIDR block was automatically set to "10.0.0.0/16".

### Subnet
According to some of the documentation I've read, in order to use a VPC you may need to set up a subnet associated with that VPC. But if you go to the Subnets section of the VPC Dashboard (with region set to Ohio), you'll see that there's already a subnet associated with the VPC, called "Public subnet". So that should be sufficient. Its Availability Zone is "us-east-2c" which probably means that all instances will be launched in the same availability zone, which is good for benchmark reproducibility.

**NOTE** It would be convenient for the subnet have auto-assign public IP enabled by default, but this subnet has it disabled by default. You may want to look into changing this or creating a new subnet with this setting.

### Security Groups
I'm under the impression that security groups are pretty important for setting up a cluster, because they determine what ports the instances are allowed to communicate on (among other things). Fortunately, this is set up by default: according to the documentation [here](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#DefaultSecurityGroup), the VPC comes with a default security group that should allow instances to communicate with each other on any ports *as long as they are all in that security group*. 

I also added the following inbound rule:
```
Type: SSH        Protocol: TCP        Port Range: 22        Source: 0.0.0.0/0
```
Without this rule, you wouldn't be able to SSH into the instances. For reference, I copied this rule from one of the "launch-wizard-xx" autogenerated security groups.

I have given the VPC's default security group the name "benchmarking-security-group".

## Launching an Instance
See the documentation [here](https://docs.aws.amazon.com/vpc/latest/userguide/working-with-vpcs.html#VPC_Launch_Instance).
1. Select the AMI/instance type as usual.
2. Under "Configure Instance Details", set "Network" to the "benchmarking-security-group" VPC and set Subnet to the "Public subnet" subnet. Also set "Auto-assign Public IP" to "Enable".
3. Under "Configure Security Group", set the security group to the onen with name "default".

## Creating the AMI
It would be useful to have an AMI which has all of the necessary dependencies installed, so we don't need to start from scratch every time we want to benchmark. Here are all the requirements/constraints I can think of for the AMI:
* To minimize data storage costs, we need to ensure that the root EBS device for the AMI is as small as possible (we'll be using an ephemeral NVMe drive for the actual benchmarks; see section **Instance Type** below). But it needs to be big enough to store all the installed libraries we're using.
* Should have the Plinycompute repo cloned already. However, note that because the AMI will be static, you should probably always do a `git pull` to make sure you're getting the most up-to-date version of the repo.
* Also because the repo will likely be up-to-date, it's probably not worthwhile to build PDB before creating the AMI; users will likely have to rebuild everything.

Given these constraints, I've created an AMI. Here are the steps I took to do this:
1. Switched my region to Ohio and went to the EC2 Dashboard. (This is important because the AMI will only be available in the region you create it in, and you'll need to spend something like 2 cents per gigabyte to move it to a different region.)
2. Selected the AMI: "Ubuntu Server 18.04 LTS (HVM), SSD Volume Type - ami-0c55b159cbfafe1f0 (64-bit x86)"
3. Selected the t3.large instance type (2 cores, 8 GiB memory). This was mostly arbitrary, because the AMI will outlive the instance. I chose an instance that a) is cheap but probably has enough resources to install things quickly enough, and b) is EBS-only to ensure everything will be installed to the EBS disk.
4. I configured the network settings as explained in **Launching an Instance**, above.
5. Under "Add Storage", I gave the root device 16 GiB to leave room for installed libraries and PDB binary files. This choice was fairly arbitrary.
6. Waited until the status checks completed (you can see this on the EC2 Dashboard).
7. Ran the following commands:
```
git clone https://github.com/dimitrijejankov/plinycompute.git
cd plinycompute
sudo ./aws/setupAMI.sh
```
8. Went to the EC2 Dashboard and created an AMI from the instance, naming it "PDB Benchmark Image". See [here](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html) for details.
9. Terminated the instance.

**NOTE:** When you're done with the AMI, you should deregister it. But this doesn't delete the EBS snapshot that was used to create the AMI, so you'll need to manually delete that or else AWS will keep charging you for it. See [here](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/deregister-ami.html#clean-up-ebs-ami) for more.
## Instance Type
